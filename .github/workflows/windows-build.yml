name: Windows Release & Winget

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: false
        default: 'debug'
        type: choice
        options:
          - debug
          - release

permissions:
  contents: write # Required to upload assets to the release

jobs:
  build-windows:
    name: Build & Bundle (Windows)
    runs-on: windows-latest
    env:
      # Default to release on main branch, otherwise use input or default to debug
      BUILD_CONFIG: ${{ github.ref == 'refs/heads/main' && 'release' || inputs.configuration || 'debug' }}
    
    steps:
      # 1. Setup Swift 6.3-DEVELOPMENT-SNAPSHOT-2026-01-03-a
      - name: Setup Swift
        uses: compnerd/gha-setup-swift@main
        with:
          swift-version: swift-6.3-branch
          swift-build: 6.3-DEVELOPMENT-SNAPSHOT-2026-01-03-a
          update-sdk-modules: true
    
      # 2. Checkout
      - name: Checkout Wendy-Agent Repository
        uses: actions/checkout@v4
        with:
            path: wendy-agent

      - name: Checkout Custom AsyncHTTPClient
        uses: actions/checkout@v4
        with:
          repository: swift-server/async-http-client
          ref: jo/windows-support
          path: async-http-client

      - name: Checkout Custom Hummingbird
        uses: actions/checkout@v4
        with:
          repository: hummingbird-project/hummingbird
          ref: jo/windows-support
          path: hummingbird
        
      - name: Checkout Custom Rainbow
        uses: actions/checkout@v4
        with:
          repository: joannis/Rainbow
          ref: jo/windows
          path: Rainbow

      - name: Checkout Custom SwiftNIO
        uses: actions/checkout@v4
        with:
          repository: joannis/swift-nio
          ref: jo/winsock-fixes
          path: swift-nio
        
      - name: Checkout Custom SwiftNIO-SSL
        uses: actions/checkout@v4
        with:
          repository: joannis/swift-nio-ssl
          ref: jo/windows-support
          path: swift-nio-ssl
        
      - name: Checkout Custom SwiftNIO-Extras
        uses: actions/checkout@v4
        with:
          repository: joannis/swift-nio-extras
          ref: jo/windows-ucrt
          path: swift-nio-extras
    
      - name: Checkout Custom DNSClient
        uses: actions/checkout@v4
        with:
          repository: orlandos-nl/DNSClient
          ref: jo/windows-support
          path: DNSClient
    
      - name: Checkout Custom GRPC SwiftNIO Transport
        uses: actions/checkout@v4
        with:
          repository: joannis/grpc-swift-nio-transport
          ref: jo/windows-support
          path: grpc-swift-nio-transport

      # 2. Provision Zlib (Check Vcpkg)
      - name: Install Visual Studio Build Tools (C++ workload)
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
      
          $installer = "$env:TEMP\vs_BuildTools.exe"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vs_BuildTools.exe" -OutFile $installer
      
          $args = @(
            "--quiet", "--wait", "--norestart", "--nocache",
            "--installPath", "C:\BuildTools",
            "--installChannelUri", "https://aka.ms/vs/17/release/channel",
            "--add", "Microsoft.VisualStudio.Workload.VCTools",
            "--includeRecommended"
          )
      
          $p = Start-Process -FilePath $installer -ArgumentList $args -PassThru -Wait
          "VS installer exit code: $($p.ExitCode)"
          if ($p.ExitCode -ne 0) { throw "VS Build Tools install failed (exit code $($p.ExitCode))" }
      
      - name: Set up MSVC dev environment
        uses: ilammy/msvc-dev-cmd@v1
  
      - name: Provision Dependencies
        shell: pwsh
        run: |
          # Vcpkg is pre-installed on windows-latest.
          # We verify zlib is present.
          $VcpkgRoot = "C:\vcpkg"
          $ZlibDll = "$VcpkgRoot\installed\x64-windows\bin\zlib1.dll"
          
          if (-not (Test-Path $ZlibDll)) {
            Write-Host "Zlib not found. Installing via vcpkg..."
            & "$VcpkgRoot\vcpkg.exe" install zlib:x64-windows
          } else {
            Write-Host "Zlib found at $ZlibDll"
          }

      # 4. Build
      # 4.1 Copy zlib.lib to z.lib
      # Otherwise we'll fail at link time.
      - name: Copy zlib.lib to z.lib
        shell: pwsh
        run: |
          Copy-Item "C:\vcpkg\installed\x64-windows\lib\zlib.lib" "C:\vcpkg\installed\x64-windows\lib\z.lib"

      # 4.2 Build wendy CLI using `swift build`
      - name: Build wendy CLI
        shell: pwsh
        run: |
          cd ${{ github.workspace }}/wendy-agent
          # We pass the include and library paths from vcpkg explicitly
          swift build -c ${{ env.BUILD_CONFIG }} --arch x86_64 --product wendy -Xcc -I"C:\vcpkg\installed\x64-windows\include" -Xlinker -L"C:\vcpkg\installed\x64-windows\lib"